class E{diff(e,t,n={}){let o;typeof n=="function"?(o=n,n={}):"callback"in n&&(o=n.callback);const s=this.castInput(e,n),a=this.castInput(t,n),f=this.removeEmpty(this.tokenize(s,n)),r=this.removeEmpty(this.tokenize(a,n));return this.diffWithOptionsObj(f,r,n,o)}diffWithOptionsObj(e,t,n,o){var s;const a=d=>{if(d=this.postProcess(d,n),o){setTimeout(function(){o(d)},0);return}else return d},f=t.length,r=e.length;let i=1,l=f+r;n.maxEditLength!=null&&(l=Math.min(l,n.maxEditLength));const p=(s=n.timeout)!==null&&s!==void 0?s:1/0,g=Date.now()+p,u=[{oldPos:-1,lastComponent:void 0}];let m=this.extractCommon(u[0],t,e,0,n);if(u[0].oldPos+1>=r&&m+1>=f)return a(this.buildValues(u[0].lastComponent,t,e));let w=-1/0,v=1/0;const L=()=>{for(let d=Math.max(w,-i);d<=Math.min(v,i);d+=2){let h;const C=u[d-1],P=u[d+1];C&&(u[d-1]=void 0);let x=!1;if(P){const D=P.oldPos-d;x=P&&0<=D&&D<f}const y=C&&C.oldPos+1<r;if(!x&&!y){u[d]=void 0;continue}if(!y||x&&C.oldPos<P.oldPos?h=this.addToPath(P,!0,!1,0,n):h=this.addToPath(C,!1,!0,1,n),m=this.extractCommon(h,t,e,d,n),h.oldPos+1>=r&&m+1>=f)return a(this.buildValues(h.lastComponent,t,e))||!0;u[d]=h,h.oldPos+1>=r&&(v=Math.min(v,d-1)),m+1>=f&&(w=Math.max(w,d+1))}i++};if(o)(function d(){setTimeout(function(){if(i>l||Date.now()>g)return o(void 0);L()||d()},0)})();else for(;i<=l&&Date.now()<=g;){const d=L();if(d)return d}}addToPath(e,t,n,o,s){const a=e.lastComponent;return a&&!s.oneChangePerToken&&a.added===t&&a.removed===n?{oldPos:e.oldPos+o,lastComponent:{count:a.count+1,added:t,removed:n,previousComponent:a.previousComponent}}:{oldPos:e.oldPos+o,lastComponent:{count:1,added:t,removed:n,previousComponent:a}}}extractCommon(e,t,n,o,s){const a=t.length,f=n.length;let r=e.oldPos,i=r-o,l=0;for(;i+1<a&&r+1<f&&this.equals(n[r+1],t[i+1],s);)i++,r++,l++,s.oneChangePerToken&&(e.lastComponent={count:1,previousComponent:e.lastComponent,added:!1,removed:!1});return l&&!s.oneChangePerToken&&(e.lastComponent={count:l,previousComponent:e.lastComponent,added:!1,removed:!1}),e.oldPos=r,i}equals(e,t,n){return n.comparator?n.comparator(e,t):e===t||!!n.ignoreCase&&e.toLowerCase()===t.toLowerCase()}removeEmpty(e){const t=[];for(let n=0;n<e.length;n++)e[n]&&t.push(e[n]);return t}castInput(e,t){return e}tokenize(e,t){return Array.from(e)}join(e){return e.join("")}postProcess(e,t){return e}get useLongestToken(){return!1}buildValues(e,t,n){const o=[];let s;for(;e;)o.push(e),s=e.previousComponent,delete e.previousComponent,e=s;o.reverse();const a=o.length;let f=0,r=0,i=0;for(;f<a;f++){const l=o[f];if(l.removed)l.value=this.join(n.slice(i,i+l.count)),i+=l.count;else{if(!l.added&&this.useLongestToken){let p=t.slice(r,r+l.count);p=p.map(function(g,u){const m=n[i+u];return m.length>g.length?m:g}),l.value=this.join(p)}else l.value=this.join(t.slice(r,r+l.count));r+=l.count,l.added||(i+=l.count)}}return o}}class T extends E{}const I=new T;function k(c,e,t){return I.diff(c,e,t)}class j extends E{constructor(){super(...arguments),this.tokenize=z}equals(e,t,n){return n.ignoreWhitespace?((!n.newlineIsToken||!e.includes(`
`))&&(e=e.trim()),(!n.newlineIsToken||!t.includes(`
`))&&(t=t.trim())):n.ignoreNewlineAtEof&&!n.newlineIsToken&&(e.endsWith(`
`)&&(e=e.slice(0,-1)),t.endsWith(`
`)&&(t=t.slice(0,-1))),super.equals(e,t,n)}}const A=new j;function M(c,e,t){return A.diff(c,e,t)}function z(c,e){e.stripTrailingCr&&(c=c.replace(/\r\n/g,`
`));const t=[],n=c.split(/(\n|\r\n)/);n[n.length-1]||n.pop();for(let o=0;o<n.length;o++){const s=n[o];o%2&&!e.newlineIsToken?t[t.length-1]+=s:t.push(s)}return t}self.addEventListener("message",c=>{const{type:e,payload:t,id:n}=c.data;let o;try{switch(e){case"diff-text":{const{oldText:s,newText:a}=t,f=M(s,a),r=k(s,a);o={type:"diff-result",payload:{lineDiff:f,charDiff:r,stats:{linesAdded:f.filter(i=>i.added).length,linesRemoved:f.filter(i=>i.removed).length,linesUnchanged:f.filter(i=>!i.added&&!i.removed).length}},id:n};break}default:throw new Error(`Unknown task type: ${e}`)}}catch(s){o={type:"error",payload:null,id:n,error:s instanceof Error?s.message:"Unknown error occurred"}}self.postMessage(o)});
